<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¿å®¢è®°å½•ç®¡ç† - Maggie's Site</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #2c332e;
            --text-muted: #6b7280;
            --primary: #4d7c5e;
            --primary-dark: #3a6048;
            --accent-bg: #edf5f0;
            --border: #e2e8f0;
            --danger: #dc2626;
            --success: #059669;
            --warning: #d97706;
            --max-width: 1200px;
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .nav-links a {
            color: var(--primary);
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .nav-links a:hover {
            background-color: var(--accent-bg);
            text-decoration: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .controls {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .controls h2 {
            margin-bottom: 20px;
            font-size: 1.2rem;
            color: var(--text-main);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }

        .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .visitor-table {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-header {
            background: var(--accent-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 1.2rem;
            color: var(--text-main);
        }

        .record-count {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--accent-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-main);
        }

        tr:hover {
            background: var(--accent-bg);
        }

        .ip-cell {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
        }

        .time-cell {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .page-cell {
            font-weight: 500;
            color: var(--primary);
        }

        .location-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success);
        }

        .status-offline {
            background-color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 8px 12px;
            }
            
            .location-cell {
                max-width: 120px;
            }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .alert-info {
            background-color: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }

        .alert-warning {
            background-color: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ” è®¿å®¢è®°å½•ç®¡ç†</h1>
            <div class="subtitle">å®æ—¶æŸ¥çœ‹å’Œç®¡ç†ç½‘ç«™è®¿å®¢ç»Ÿè®¡æ•°æ®</div>
            <div class="nav-links">
                <a href="index.html">â† è¿”å›é¦–é¡µ</a>
                <a href="publications.html">ğŸ“š è®ºæ–‡é¡µé¢</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æç¤ºä¿¡æ¯ -->
        <div class="alert alert-info">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šä¸¢å¤±è®°å½•ã€‚å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="total-visits">0</span>
                <div class="stat-label">ğŸ“Š æ€»è®¿é—®æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="unique-visitors">0</span>
                <div class="stat-label">ğŸ‘¥ ç‹¬ç«‹è®¿å®¢</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="today-visits">0</span>
                <div class="stat-label">ğŸ“… ä»Šæ—¥è®¿é—®</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="this-week-visits">0</span>
                <div class="stat-label">ğŸ“ˆ æœ¬å‘¨è®¿é—®</div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <h2>ğŸ› ï¸ æ•°æ®ç®¡ç†</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="refreshData()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    ğŸ“¥ å¯¼å‡ºæ•°æ®
                </button>
                <button class="btn btn-warning" onclick="showStats()">
                    ğŸ“Š è¯¦ç»†ç»Ÿè®¡
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                </button>
            </div>
            
            <div class="filter-section">
                <input type="text" class="filter-input" id="ip-filter" placeholder="ğŸ” æŒ‰IPåœ°å€ç­›é€‰...">
                <input type="text" class="filter-input" id="location-filter" placeholder="ğŸŒ æŒ‰ä½ç½®ç­›é€‰...">
                <input type="text" class="filter-input" id="page-filter" placeholder="ğŸ“„ æŒ‰é¡µé¢ç­›é€‰...">
                <button class="btn btn-primary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                <button class="btn btn-primary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
            </div>
        </div>

        <!-- è®¿å®¢è®°å½•è¡¨æ ¼ -->
        <div class="visitor-table">
            <div class="table-header">
                <h2>ğŸ“‹ è®¿å®¢è®°å½•è¯¦æƒ…</h2>
                <div class="record-count" id="record-count">å…± 0 æ¡è®°å½•</div>
            </div>
            <div class="table-container">
                <table id="visitor-table">
                    <thead>
                        <tr>
                            <th>â° è®¿é—®æ—¶é—´</th>
                            <th>ğŸŒ IPåœ°å€</th>
                            <th>ğŸ“ ä½ç½®ä¿¡æ¯</th>
                            <th>ğŸ“„ è®¿é—®é¡µé¢</th>
                            <th>ğŸ”— æ¥æº</th>
                            <th>ğŸ¢ ISP</th>
                        </tr>
                    </thead>
                    <tbody id="visitor-tbody">
                        <tr>
                            <td colspan="6" class="loading">
                                <div>ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        class VisitorAdmin {
            constructor() {
                this.visitors = [];
                this.filteredVisitors = [];
                this.init();
            }

            init() {
                this.loadData();
                this.updateStats();
                this.renderTable();
            }

            loadData() {
                try {
                    this.visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
                    this.filteredVisitors = [...this.visitors];
                    console.log('âœ… åŠ è½½äº†', this.visitors.length, 'æ¡è®¿å®¢è®°å½•');
                } catch (error) {
                    console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                    this.visitors = [];
                    this.filteredVisitors = [];
                }
            }

            updateStats() {
                try {
                    const totalVisits = parseInt(localStorage.getItem('visitCount') || '0');
                    const uniqueIPs = new Set(this.visitors.map(v => v.ip));
                    
                    const today = new Date().toDateString();
                    const todayVisits = this.visitors.filter(v => v.date === today);
                    
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const thisWeekVisits = this.visitors.filter(v => new Date(v.timestamp) >= weekAgo);

                    document.getElementById('total-visits').textContent = totalVisits.toLocaleString();
                    document.getElementById('unique-visitors').textContent = uniqueIPs.size.toLocaleString();
                    document.getElementById('today-visits').textContent = todayVisits.length.toLocaleString();
                    document.getElementById('this-week-visits').textContent = thisWeekVisits.length.toLocaleString();
                } catch (error) {
                    console.error('âŒ æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
                }
            }

            renderTable() {
                const tbody = document.getElementById('visitor-tbody');
                const recordCount = document.getElementById('record-count');
                
                if (this.filteredVisitors.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-data">
                                <div class="no-data-icon">ğŸ“­</div>
                                <div>æš‚æ— è®¿å®¢è®°å½•</div>
                            </td>
                        </tr>
                    `;
                    recordCount.textContent = 'å…± 0 æ¡è®°å½•';
                    return;
                }

                // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                const sortedVisitors = [...this.filteredVisitors].sort((a, b) => 
                    new Date(b.timestamp) - new Date(a.timestamp)
                );

                tbody.innerHTML = sortedVisitors.map(visitor => {
                    const date = new Date(visitor.timestamp);
                    const timeStr = date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const page = visitor.page || 'index';
                    const referrer = this.formatReferrer(visitor.referrer);
                    const location = this.formatLocation(visitor);
                    const isp = visitor.isp || 'æœªçŸ¥';

                    return `
                        <tr>
                            <td class="time-cell">${timeStr}</td>
                            <td class="ip-cell">${visitor.ip}</td>
                            <td class="location-cell" title="${location}">${location}</td>
                            <td class="page-cell">${page}</td>
                            <td title="${visitor.referrer || 'ç›´æ¥è®¿é—®'}">${referrer}</td>
                            <td title="${isp}">${isp.length > 20 ? isp.substring(0, 20) + '...' : isp}</td>
                        </tr>
                    `;
                }).join('');

                recordCount.textContent = `å…± ${this.filteredVisitors.length} æ¡è®°å½•`;
            }

            formatLocation(visitor) {
                const parts = [];
                if (visitor.city && visitor.city !== 'Unknown') parts.push(visitor.city);
                if (visitor.region && visitor.region !== 'Unknown' && visitor.region !== visitor.city) {
                    parts.push(visitor.region);
                }
                if (visitor.country && visitor.country !== 'Unknown') {
                    parts.push(visitor.country);
                }
                return parts.length > 0 ? parts.join(', ') : 'æœªçŸ¥ä½ç½®';
            }

            formatReferrer(referrer) {
                if (!referrer || referrer === 'direct') return 'ğŸ”— ç›´æ¥è®¿é—®';
                try {
                    const url = new URL(referrer);
                    return `ğŸŒ ${url.hostname}`;
                } catch {
                    return 'ğŸ”— å…¶ä»–æ¥æº';
                }
            }

            applyFilters() {
                const ipFilter = document.getElementById('ip-filter').value.toLowerCase();
                const locationFilter = document.getElementById('location-filter').value.toLowerCase();
                const pageFilter = document.getElementById('page-filter').value.toLowerCase();

                this.filteredVisitors = this.visitors.filter(visitor => {
                    const matchesIP = !ipFilter || visitor.ip.toLowerCase().includes(ipFilter);
                    const location = this.formatLocation(visitor).toLowerCase();
                    const matchesLocation = !locationFilter || location.includes(locationFilter);
                    const page = (visitor.page || 'index').toLowerCase();
                    const matchesPage = !pageFilter || page.includes(pageFilter);
                    
                    return matchesIP && matchesLocation && matchesPage;
                });

                this.renderTable();
                console.log('ğŸ” ç­›é€‰ç»“æœ:', this.filteredVisitors.length, 'æ¡è®°å½•');
            }

            clearFilters() {
                document.getElementById('ip-filter').value = '';
                document.getElementById('location-filter').value = '';
                document.getElementById('page-filter').value = '';
                this.filteredVisitors = [...this.visitors];
                this.renderTable();
                console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶');
            }

            exportData() {
                try {
                    const exportData = {
                        exportTime: new Date().toISOString(),
                        totalRecords: this.visitors.length,
                        visitors: this.visitors
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `visitor-logs-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    alert('ğŸ“¥ æ•°æ®å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æ‚¨çš„è®¾å¤‡ã€‚');
                    console.log('ğŸ“¥ å¯¼å‡ºäº†', this.visitors.length, 'æ¡è®°å½•');
                } catch (error) {
                    console.error('âŒ å¯¼å‡ºå¤±è´¥:', error);
                    alert('âŒ å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ã€‚');
                }
            }

            clearAllData() {
                if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¿å®¢æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå»ºè®®å…ˆå¯¼å‡ºæ•°æ®è¿›è¡Œå¤‡ä»½ã€‚')) {
                    try {
                        localStorage.removeItem('visitors');
                        localStorage.removeItem('visitCount');
                        alert('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚');
                        console.log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è®¿å®¢æ•°æ®');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        console.error('âŒ æ¸…é™¤æ•°æ®å¤±è´¥:', error);
                        alert('âŒ æ¸…é™¤æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ã€‚');
                    }
                }
            }

            refreshData() {
                this.init();
                alert('ğŸ”„ æ•°æ®å·²åˆ·æ–°ï¼');
                console.log('ğŸ”„ æ•°æ®å·²åˆ·æ–°');
            }

            showStats() {
                const stats = this.generateDetailedStats();
                const statsWindow = window.open('', '_blank', 'width=800,height=600');
                statsWindow.document.write(`
                    <html>
                        <head>
                            <title>è¯¦ç»†ç»Ÿè®¡ - Maggie's Site</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                .stat-item { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
                                .stat-title { font-weight: bold; color: #333; }
                                .stat-value { color: #666; }
                            </style>
                        </head>
                        <body>
                            <h1>ğŸ“Š è®¿å®¢ç»Ÿè®¡è¯¦æƒ…</h1>
                            ${stats}
                        </body>
                    </html>
                `);
            }

            generateDetailedStats() {
                const countries = {};
                const pages = {};
                const hours = new Array(24).fill(0);
                
                this.visitors.forEach(visitor => {
                    // ç»Ÿè®¡å›½å®¶
                    const country = visitor.country || 'æœªçŸ¥';
                    countries[country] = (countries[country] || 0) + 1;
                    
                    // ç»Ÿè®¡é¡µé¢
                    const page = visitor.page || 'index';
                    pages[page] = (pages[page] || 0) + 1;
                    
                    // ç»Ÿè®¡è®¿é—®æ—¶é—´
                    const hour = new Date(visitor.timestamp).getHours();
                    hours[hour]++;
                });

                const topCountries = Object.entries(countries)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                const topPages = Object.entries(pages)
                    .sort(([,a], [,b]) => b - a);

                return `
                    <div class="stat-item">
                        <div class="stat-title">ğŸŒ è®¿å®¢æ¥æºå›½å®¶ TOP 10</div>
                        <div class="stat-value">
                            ${topCountries.map(([country, count]) => 
                                `${country}: ${count} æ¬¡è®¿é—®`
                            ).join('<br>')}
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">ğŸ“„ é¡µé¢è®¿é—®ç»Ÿè®¡</div>
                        <div class="stat-value">
                            ${topPages.map(([page, count]) => 
                                `${page}: ${count} æ¬¡è®¿é—®`
                            ).join('<br>')}
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">â° è®¿é—®æ—¶é—´åˆ†å¸ƒ</div>
                        <div class="stat-value">
                            ${hours.map((count, hour) => 
                                `${hour.toString().padStart(2, '0')}:00 - ${count} æ¬¡è®¿é—®`
                            ).filter((_, hour) => hours[hour] > 0).join('<br>')}
                        </div>
                    </div>
                `;
            }
        }

        // å…¨å±€å‡½æ•°
        function refreshData() {
            window.adminPanel.refreshData();
        }

        function exportData() {
            window.adminPanel.exportData();
        }

        function clearAllData() {
            window.adminPanel.clearAllData();
        }

        function applyFilters() {
            window.adminPanel.applyFilters();
        }

        function clearFilters() {
            window.adminPanel.clearFilters();
        }

        function showStats() {
            window.adminPanel.showStats();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.adminPanel = new VisitorAdmin();
        });

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.classList.contains('filter-input')) {
                applyFilters();
            }
        });

        // å®šæœŸè‡ªåŠ¨åˆ·æ–°æ•°æ®
        setInterval(() => {
            if (window.adminPanel) {
                window.adminPanel.loadData();
                window.adminPanel.updateStats();
            }
        }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>
